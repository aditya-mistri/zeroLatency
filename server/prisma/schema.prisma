generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String            @id @default(cuid())
  email               String            @unique
  password            String
  firstName           String
  lastName            String
  phone               String?
  role                UserRole          @default(PATIENT)
  avatar              String?
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  dateOfBirth         DateTime?
  gender              String?
  address             String?
  doctorAppointments  Appointment[]     @relation("DoctorAppointments")
  patientAppointments Appointment[]     @relation("PatientAppointments")
  chatMessages        ChatMessage[]
  doctorProfile       DoctorProfile?
  sessionRecords      SessionRecord[]
  verificationDocs    VerificationDoc[]

  @@map("users")
}

model DoctorProfile {
  id                String               @id @default(cuid())
  userId            String               @unique
  specialization    String
  experience        Int
  qualification     String
  licenseUrl        String?              // Medical license/degree certificate
  bio               String?
  consultationFee   Float
  status            DoctorStatus         @default(PENDING)
  hospitalId        String?
  availableSlots    Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  hospital          Hospital?            @relation(fields: [hospitalId], references: [id])
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  availabilitySlots DoctorAvailability[]

  @@map("doctor_profiles")
}

model DoctorAvailability {
  id              String        @id @default(cuid())
  doctorProfileId String
  date            DateTime // Specific date (YYYY-MM-DD)
  startTime       String // Format: "09:00"
  endTime         String // Format: "17:00"
  slotDuration    Int           @default(30) // Duration of each slot in minutes
  isAvailable     Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  doctorProfile   DoctorProfile @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)

  @@unique([doctorProfileId, date])
  @@map("doctor_availability")
}

model Hospital {
  id          String          @id @default(cuid())
  name        String
  address     String
  city        String
  state       String
  zipCode     String
  phone       String
  email       String?
  website     String?
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  doctors     DoctorProfile[]

  @@map("hospitals")
}

model Appointment {
  id            String            @id @default(cuid())
  patientId     String
  doctorId      String
  scheduledAt   DateTime
  duration      Int               @default(30)
  status        AppointmentStatus @default(PAYMENT_PENDING)
  meetingLink   String?
  notes         String?
  amount        Float
  paymentId     String?
  paymentStatus PaymentStatus     @default(PENDING)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  doctor        User              @relation("DoctorAppointments", fields: [doctorId], references: [id])
  patient       User              @relation("PatientAppointments", fields: [patientId], references: [id])
  chatMessages  ChatMessage[]
  sessionRecord SessionRecord?

  @@map("appointments")
}

model SessionRecord {
  id            String        @id @default(cuid())
  appointmentId String        @unique
  userId        String
  transcript    String?
  summary       String?
  recordings    Json?
  duration      Int?
  startedAt     DateTime?
  endedAt       DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  appointment   Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id])
  prescription  Prescription?

  @@map("session_records")
}

model Prescription {
  id              String        @id @default(cuid())
  sessionRecordId String        @unique
  appointmentId   String
  patientId       String
  doctorId        String
  diagnosis       String
  medications     Json // Array of {name, dosage, frequency, duration, instructions}
  labTests        String? // Recommended lab tests
  advice          String? // General medical advice
  followUpDate    DateTime?
  status          String        @default("DRAFT") // DRAFT or SENT
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  sessionRecord   SessionRecord @relation(fields: [sessionRecordId], references: [id], onDelete: Cascade)

  @@map("prescriptions")
}

model ChatMessage {
  id            String      @id @default(cuid())
  appointmentId String
  senderId      String
  message       String
  messageType   String      @default("text") // "text", "file", "image"
  metadata      Json? // For files: {fileName, fileUrl, fileSize, mimeType}
  fileUrl       String? // Direct URL to uploaded file
  sentAt        DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  sender        User        @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

model VerificationDoc {
  id         String    @id @default(cuid())
  userId     String
  docType    String
  fileName   String
  fileUrl    String
  status     String    @default("pending")
  uploadedAt DateTime  @default(now())
  reviewedAt DateTime?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("verification_docs")
}

enum UserRole {
  PATIENT
  DOCTOR
  MODERATOR
}

enum DoctorStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AppointmentStatus {
  PAYMENT_PENDING
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
